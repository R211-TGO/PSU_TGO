<form hx-post="{{ url_for('emissions.save_materials') }}"
      hx-target="#table-container"
      hx-swap="innerHTML"
      class="max-w-screen-xl mx-auto w-full" {# ขยายความกว้างของโมดัลเป็น max-w-screen-xl #}
      style="max-height: 700px; overflow-y: auto;"
      id="materials-form">
      
    <!-- ส่วนหัวข้อ -->
    <div class="mt-2 flex justify-between items-center">
        <h2 class="font-medium text-2xl text-gray-900 px-8">แก้ไขข้อมูลประจำเดือน {{ month }} ({{ year }})</h2>
        <button type="button" class="text-gray-500 hover:text-gray-700 focus:outline-none"
                hx-on="click: document.getElementById('modal').classList.remove('modal-open')">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    
    <div class="bg-white rounded-lg p-6 grid grid-cols-1 gap-6">

        <!-- ลูปหัวข้อหลัก -->
        {% for head in head_table %}
        <div class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
            <div class="mb-4">
                <label class="text-gray-700 font-medium text-lg">ประเภท :</label>
                <label class="block mb-1 text-gray-500 ">{{ head }}</label>
            </div>
            
            {% set num_inputs = materials_form[loop.index0] | length %}
            
            <!-- ลูปข้อมูลใน materials_form พร้อมปรับ grid ตามจำนวนหัวย่อย -->
            <div class="grid 
                {% if num_inputs == 4 %}
                    grid-cols-4
                {% elif num_inputs == 2 %}
                    grid-cols-2
                {% else %} {# ถ้ามี 1 หัวย่อย ให้จัดเป็น 4 คอลัมน์ (เพื่อให้กว้างเท่าเดิม) #}
                    grid-cols-4
                {% endif %} 
                gap-6">
                {% for input in materials_form[loop.index0] %}
                    {% set matched_material = materials | selectattr('name', 'equalto', head) | list %}
                    {% set matched_quantity = matched_material | map(attribute='quantity_type') | sum(start=[]) | selectattr('field', 'equalto', input.field) | list %}
                    <div class="mb-2 
                        {% if num_inputs == 1 %}
                            col-span-4 {# ถ้ามี 1 หัวย่อย ให้ input นั้นกินพื้นที่ 4 คอลัมน์ #}
                        {% endif %}
                    ">
                        <label class="block text-sm font-medium text-gray-700">{{ input.label }} ({{ input.unit }}):</label>
                        <input
                          type="number"
                          step="any"
                          name="amount_{{ head }}_{{ input.field }}"
                          class="w-full rounded-md px-3 py-2 border border-gray-300 focus:ring-blue-500 focus:border-blue-500" {# ใช้คลาส Tailwind โดยตรง ไม่ใช้ input-bordered #}
                          placeholder="ระบุ - {{ input.unit }}"
                          value="{{ matched_quantity[0].amount if matched_quantity else '' }}"
                        >
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Hidden Inputs -->
        <input type="hidden" name="scope_id" value="{{ request.args.get('scope_id') }}">
        <input type="hidden" name="sub_scope_id" value="{{ request.args.get('sub_scope_id') }}">
        <input type="hidden" name="page" value="{{ request.args.get('page', 1) }}">
        <input type="hidden" name="year" value="{{ request.args.get('year', '') }}">
        <input type="hidden" name="month_id" value="{{ month_id }}">
    </div>

    <!-- ปุ่ม -->
    <div class="flex justify-between items-center px-8">
        <!-- ปุ่มลบ -->
        <button type="button" class="btn btn-outline btn-error px-4 py-2 text-red rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out"
                hx-post="{{ url_for('emissions.delete_all_materials') }}"
                hx-target="#table-container"
                hx-swap="innerHTML"
                hx-vals='{
                    "scope_id": "{{ request.args.get("scope_id") }}",
                    "sub_scope_id": "{{ request.args.get("sub_scope_id") }}",
                    "month_id": "{{ month_id }}",
                    "year": "{{ request.args.get("year") }}"
                }'
                hx-on="click: document.getElementById('modal').classList.remove('modal-open')">
            Delete All
        </button>

        <!-- ปุ่ม Cancel และ Save Changes -->
        <div class="flex space-x-2">
            <button type="button" class="btn btn-outline"
                    hx-on="click: document.getElementById('modal').classList.remove('modal-open')">
                Cancel
            </button>
            <button type="submit" class="btn btn-primary"
                    hx-on="click: document.getElementById('modal').classList.remove('modal-open')">
                Save Changes
            </button>
        </div>
    </div>
</form>

<script>
    // สคริปต์นี้จะทำงานทันทีหลังจาก HTMX ทำการโหลดและแสดงผลฟอร์ม
    // เพื่อเลื่อนเนื้อหาของโมดัลไปที่ด้านบนสุดตั้งแต่ครั้งแรก
    const modalElement = document.getElementById('modal'); // สมมติว่า id ของโมดัลหลักของคุณคือ 'modal'
    if (modalElement) {
        modalElement.scrollTop = 0; // เลื่อนเนื้อหาโมดัลไปด้านบนสุด
    }
</script>
