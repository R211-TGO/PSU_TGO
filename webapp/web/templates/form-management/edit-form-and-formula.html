<div class="max-w-6xl mx-auto px-6 py-8">
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <div class="flex justify-end mb-4">
  <button type="button" 
          class="btn btn-sm btn-ghost text-gray-700 hover:text-gray-900 hover:bg-gray-100" 
          onclick="document.getElementById('modal').classList.remove('modal-open');"
          title="‡∏õ‡∏¥‡∏î‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û">
    <i data-feather="x" class="h-5 w-5 mr-1"></i>
  </button>
</div>

  <!-- Checkbox ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle preview (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
  <input type="checkbox" id="preview-toggle" class="hidden" checked>

  <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å grid ‡πÄ‡∏õ‡πá‡∏ô main-container -->
  <div class="main-container">
    <!-- Left: Edit Form Field -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-black-600 font-bold text-lg border-b border-b-gray-200 pb-3">{{ t.edit_form_field }}</h3>
        <!-- ‡∏õ‡∏∏‡πà‡∏° toggle ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
        <label for="preview-toggle" class="btn btn-sm btn-ghost text-gray-600 hover:text-gray-800 hover:bg-gray-100 cursor-pointer" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß">
          <i data-feather="eye" class="h-5 w-5 mr-1"></i>
          ‡∏ã‡πà‡∏≠‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
        </label>
      </div>
      
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô... -->
      <form method="POST" action="{{ url_for('form_management.edit_form_and_formula') }}" onsubmit="submitEditForm(event)">
        <input type="hidden" name="form_id" value="{{ form.id if form else '' }}">

        <!-- Form Metadata -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

          <div>
            <label class="text-font">{{ t.material_name }}</label>
            <input 
              type="text" 
              name="material_name" 
              class="input input-bordered w-full mt-1" 
              placeholder="Enter material name" 
              value="{{ form.material_name if form else '' }}" 
              oninput="updatePreview()" 
              required>
          </div>

          <!-- Main Scope Selection -->
          <div>
            <label class="text-font">Main Scope</label>
            <select 
              name="scope" 
              id="main-scope"
              class="select select-bordered w-full mt-1 cursor-not-allowed bg-gray-50" 
              disabled>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Main Scope</option>
              <option value="1" {{ 'selected' if form and form.ghg_scope == 1 else '' }}>Scope 1</option>
              <option value="2" {{ 'selected' if form and form.ghg_scope == 2 else '' }}>Scope 2</option>
              <option value="3" {{ 'selected' if form and form.ghg_scope == 3 else '' }}>Scope 3</option>
            </select>
            <input type="hidden" name="scope" value="{{ form.ghg_scope if form else '' }}">
          </div>

          <!-- Sub Scope Selection -->
          <div>
            <label class="text-font">Sub Scope</label>
            <div id="sub-scope-container">
              <select name="sup_scope" class="select select-bordered w-full mt-1 cursor-not-allowed bg-gray-50" disabled>
                {% if form and form.ghg_sup_scope %}
                  <option value="{{ form.ghg_sup_scope }}" selected>{{ form.ghg_sup_scope }}</option>
                {% else %}
                  <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sub Scope</option>
                {% endif %}
              </select>
              <input type="hidden" name="sup_scope" value="{{ form.ghg_sup_scope if form else '' }}">
            </div>
          </div>

          <div class="sm:col-span-2">
            <label class="text-font">{{ t.form_description }}</label>
            <textarea 
              name="desc_form" 
              class="textarea textarea-bordered w-full mt-1" 
              placeholder="Enter form description" 
              oninput="updatePreview()"
            >{{ form.desc_form if form else '' }}</textarea>
          </div>
        </div>

        <!-- Define Input Fields -->
        {% if not (form and form.is_linked) %}
        <div class="mt-6">
          <label class="text-font">{{ t.define_input_fields }}</label>
          <div id="input-fields-container" class="space-y-4">
            <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
          </div>
          <!-- ‡∏õ‡∏∏‡πà‡∏° Add Input Field -->
          <button 
            type="button" 
            class="btn btn-outline btn-lg mt-2 w-full border-dashed flex items-center justify-center gap-3 py-4 bg-gray-50 hover:bg-gray-100 text-gray-600 text-sm" 
            onclick="addInputField()">
            <i data-feather="plus" class="w-6 h-6"></i>
            {{ t.add_input_field }}
          </button>
        </div>
        {% else %}
        <div class="mt-6">
          <div class="alert bg-emerald-50 border border-emerald-300 text-emerald-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 text-emerald-600" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold text-emerald-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á</h3>
              <div class="text-sm mt-2">
                <p><strong>üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Material:</strong> <span class="font-mono bg-cyan-100 border border-cyan-300 px-2 py-1 rounded text-cyan-800">{{ form.linked_material_name }}</span></p>
                <p class="mt-1"><strong>üìä Scope:</strong> <span class="text-teal-700">{{ form.ghg_scope }}</span> | <strong>Sub-Scope:</strong> <span class="text-teal-700">{{ form.ghg_sup_scope }}</span></p>
                <p class="text-xs text-emerald-700 mt-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Material ‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
              </div>
            </div>
          </div>
          
          <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
          <div class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-emerald-50 border-2 border-sky-200 rounded-lg">
            <h4 class="text-sm font-medium text-teal-800 mb-3">‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h4>
            <div class="mb-3">
              <label class="block text-sm text-blue-800 mb-1">
                <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) (unit)</strong>
              </label>
              <input type="number" class="input input-bordered w-full text-sm bg-cyan-50 border-cyan-200" value="[‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å {{ form.linked_material_name }}]" readonly>
              <div class="flex gap-2 mt-1">
                <div class="text-xs text-teal-800 bg-teal-100 border border-teal-300 rounded-full px-2 py-1 inline-block">Field: buffer_data</div>
                <div class="text-xs text-emerald-800 bg-emerald-100 border border-emerald-300 rounded-full px-2 py-1 inline-block">Type: auto-generated</div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Formula Section -->
        <div class="mt-6">
          <label class="text-font">{{t.formula}}</label>
          <div class="relative mb-4">
            <div class="flex">
              <input 
                type="text" 
                name="formula" 
                id="formula" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. diesel * 2.68" 
                value="{{ form.formula if form else '' }}"
                readonly 
                required
                onclick="toggleFormulaCalculator()">
              
              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormulaCalculator()"
                      title="Open Formula Calculator">
                <i data-feather="grid" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>
            
            <!-- Formula Calculator Dropdown -->
            <div id="formula-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{t.formula_builder}}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormulaCalculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>

              <!-- Variables Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-cyan-700 mb-2">{{ t.variables }}</h5>
                {% if form and form.is_linked %}
                <div class="grid grid-cols-4 gap-2">
                  <button type="button" class="btn btn-xs border border-teal-300 text-teal-700 bg-teal-50 hover:bg-teal-100" onclick="addToFormula('buffer_data')">buffer_data</button>
                </div>
                <p class="text-xs text-blue-600 mt-2">
                  ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ 'buffer_data' ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Material: <strong class="text-cyan-700">{{ form.linked_material_name }}</strong>
                </p>
                {% else %}
                <div class="grid grid-cols-4 gap-2" id="variables-buttons">
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
                {% endif %}
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.numbers }}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers-buttons">
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.operators }}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators-buttons">
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormulaCalculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Formula Description -->
        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_description }}</label>
          <textarea 
            name="desc_formula" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_description }}" 
            oninput="updatePreview()"
          >{{ form.desc_formula if form else '' }}</textarea>
        </div>

       

        <div class="mt-6 flex justify-between">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö -->
          <button type="button" class="btn btn-outline btn-error" onclick="confirmDelete('{{ form.id }}', '{{ form.material_name }}')">
            {{t.delete_form}}
          </button>
          
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å -->
          <div class="flex gap-3">
            <button type="button" class="btn btn-outline" onclick="document.getElementById('modal').classList.remove('modal-open')">{{t.cancel}}</button>
            <button type="submit" class="btn btn-primary">{{t.save_changes}}</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Right: Form Preview -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6 transition-all duration-300 preview-panel">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-black-600 font-bold text-lg">{{ t.form_preview }}</h3>
        <label for="preview-toggle" class="btn btn-sm btn-ghost text-gray-500 hover:text-gray-700 hover:bg-gray-100 cursor-pointer" title="‡∏õ‡∏¥‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </label>
      </div>
      <div id="form-preview" class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
        <!-- ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏° -->
      </div>
    </div>
  </div>
</div>

<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
<style>
/* Grid layout ‡∏´‡∏•‡∏±‡∏Å */
.main-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  transition: all 0.3s ease-in-out;
}

/* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ checkbox ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏õ‡∏¥‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß) */
#preview-toggle:not(:checked) ~ .main-container {
  grid-template-columns: 1fr 0fr !important;
}

#preview-toggle:not(:checked) ~ .main-container .preview-panel {
  width: 0 !important;
  min-width: 0 !important;
  opacity: 0 !important;
  overflow: hidden !important;
  padding: 0 !important;
  margin: 0 !important;
  border: none !important;
}

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏° */
#preview-toggle:checked ~ .main-container .toggle-text::before {
  content: "‡∏ã‡πà‡∏≠‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß";
}

#preview-toggle:not(:checked) ~ .main-container .toggle-text::before {
  content: "‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß";
}

.toggle-text {
  display: none;
}

.toggle-text::before {
  display: inline;
}

/* Smooth transitions */
.preview-panel,
.main-container {
  transition: all 0.3s ease-in-out;
}

/* Responsive */
@media (max-width: 1280px) {
  .main-container {
    grid-template-columns: 1fr !important;
  }
  
  #preview-toggle:not(:checked) ~ .main-container .preview-panel {
    display: none !important;
  }
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ form section ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß */
#preview-toggle:not(:checked) ~ .main-container > div:first-child {
  width: 100% !important;
  max-width: none !important;
}
</style>

<!-- JavaScript ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -->
<script src="{{ url_for('static', filename='js/form-calculator.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ‡πÄ‡∏Å‡πá‡∏ö JavaScript ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
// ‡πÄ‡∏û‡∏¥‡πà‡∏° functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö formula calculator
function addToFormula(value) {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        const currentValue = formulaInput.value || "";
        formulaInput.value = currentValue + value;
        updatePreview();
    }
}

function clearFormula() {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        formulaInput.value = "";
        updatePreview();
    }
}

function toggleFormulaCalculator() {
    const calculator = document.getElementById("formula-calculator");
    const dropdownBtn = document.getElementById("formula-dropdown-btn");
    
    if (calculator.classList.contains("hidden")) {
        calculator.classList.remove("hidden");
        const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
        if (chevron) chevron.style.transform = "rotate(180deg)";
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç
        updateCalculatorButtons();
    } else {‡∏´
        calculator.classList.add("hidden");
        const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
        if (chevron) chevron.style.transform = "rotate(0deg)";
    }
}

function closeFormulaCalculator() {
    const calculator = document.getElementById("formula-calculator");
    const dropdownBtn = document.getElementById("formula-dropdown-btn");
    
    calculator.classList.add("hidden");
    const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
    if (chevron) chevron.style.transform = "rotate(0deg)";
}

function applyFormula() {
    closeFormulaCalculator();
    updatePreview();
}

function updateCalculatorButtons() {
    const isLinked = {{ 'true' if form and form.is_linked else 'false' }};
    
    console.log("Updating calculator buttons, isLinked:", isLinked);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ - ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô HTML)
    if (!isLinked) {
        updateFormulaButtons();
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå)
    populateNumbersButtons();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå)
    populateOperatorsButtons();
}

function updateFormulaButtons() {
    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    const container = document.getElementById("input-fields-container");
    const variablesButtons = document.getElementById("variables-buttons");
    
    if (!container || !variablesButtons) return;
    
    variablesButtons.innerHTML = "";
    
    const fieldInputs = container.querySelectorAll("input[name='field']");
    fieldInputs.forEach(input => {
        if (input.value.trim()) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn btn-xs btn-outline";
            button.textContent = input.value.trim();
            button.onclick = () => addToFormula(input.value.trim());
            variablesButtons.appendChild(button);
        }
    });
}

function populateNumbersButtons() {
    const numbersButtons = document.getElementById("numbers-buttons");
    if (!numbersButtons) return;
    
    numbersButtons.innerHTML = "";
    
    // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9
    for (let i = 0; i <= 9; i++) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn btn-xs btn-outline";
        button.textContent = i.toString();
        button.onclick = () => addToFormula(i.toString());
        numbersButtons.appendChild(button);
    }
    
    // ‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    const decimalButton = document.createElement("button");
    decimalButton.type = "button";
    decimalButton.className = "btn btn-xs btn-outline";
    decimalButton.textContent = ".";
    decimalButton.onclick = () => addToFormula(".");
    numbersButtons.appendChild(decimalButton);
}

function populateOperatorsButtons() {
    const operatorsButtons = document.getElementById("operators-buttons");
    if (!operatorsButtons) return;
    
    operatorsButtons.innerHTML = "";
    
    const operators = ['+', '-', '*', '/', '(', ')', '^', 'sqrt', '‚å´', 'C'];
    
    operators.forEach(op => {
        const button = document.createElement("button");
        button.type = "button";
        
        if (op === '‚å´') {
            button.textContent = "‚å´";
            button.className = "btn btn-xs btn-error";
            button.onclick = () => removeLastCharacter();
        } else if (op === 'C') {
            button.textContent = "Clear";
            button.className = "btn btn-xs btn-warning";
            button.onclick = () => clearFormula();
        } else if (op === 'sqrt') {
            button.textContent = "‚àö";
            button.className = "btn btn-xs btn-outline";
            button.onclick = () => addToFormula("sqrt(");
        } else {
            button.textContent = op;
            button.className = "btn btn-xs btn-outline";
            button.onclick = () => addToFormula(op);
        }
        
        operatorsButtons.appendChild(button);
    });
}

function removeLastCharacter() {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        formulaInput.value = formulaInput.value.slice(0, -1);
        updatePreview();
    }
}

function submitEditForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    submitButton.disabled = true;

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: data.message,
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            }).then(() => {
                window.location.href = data.redirect_url;
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                text: data.message,
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
    })
    .finally(() => {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
}

function initializeForm() {
    inputFieldCount = 0;
    currentFormula = '';
    const container = document.getElementById("input-fields-container");
    if (container) container.innerHTML = "";
    
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å template ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ fetch
    const form = {{ form|tojson if form else 'null' }};
    if (form) {
        loadFormData(form);
    } else {
        addInputField();
        setTimeout(() => {
            updatePreview();
            updateCalculatorButtons();
            feather.replace();
        }, 100);
    }
}

function loadFormData(formData) {
    const container = document.getElementById("input-fields-container");
    if (container) container.innerHTML = "";
    inputFieldCount = 0;
    
    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î input fields
    if (!formData.is_linked && formData.input_types && formData.input_types.length > 0) {
        formData.input_types.forEach(inputField => {
            addInputField({
                field: inputField.field,
                label: inputField.label,
                input_type: inputField.input_type,
                unit: inputField.unit
            });
        });
    } else if (!formData.is_linked) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ input types
        addInputField();
    }
    // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î input fields
    
    setTimeout(() => {
        // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        if (formData.material_name) {
            const materialInput = document.querySelector("input[name='material_name']");
            if (materialInput) materialInput.value = formData.material_name;
        }
        if (formData.desc_form) {
            const descFormTextarea = document.querySelector("textarea[name='desc_form']");
            if (descFormTextarea) descFormTextarea.value = formData.desc_form;
        }
        if (formData.formula) {
            const formulaInput = document.querySelector("input[name='formula']");
            if (formulaInput) formulaInput.value = formData.formula;
        }
        if (formData.desc_formula) {
            const descFormulaTextarea = document.querySelector("textarea[name='desc_formula']");
            if (descFormulaTextarea) descFormulaTextarea.value = formData.desc_formula;
        }
        if (formData.ghg_scope) {
            const mainScopeSelect = document.querySelector("select[name='scope']");
            if (mainScopeSelect) mainScopeSelect.value = formData.ghg_scope;
        }
        
        setTimeout(() => {
            htmx.trigger(document.body, 'refreshSubScope');
            setTimeout(() => {
                updatePreview();
                updateCalculatorButtons(); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                feather.replace();
            }, 200);
        }, 100);
    }, 50);
}

function updatePreview() {
    const container = document.getElementById("input-fields-container");
    const preview = document.getElementById("form-preview");
    const materialName = (document.querySelector("input[name='material_name']").value || "NO MATERIAL NAME").toUpperCase();
    
    // Check if form is linked
    const isLinked = {{ 'true' if form and form.is_linked else 'false' }};
    
    let html = "";
    html += `<div class="mb-6"><p class="text-sm text-gray-400"><strong>{{ t.material_name|upper }}:</strong> ${materialName}</p></div>`;

    if (isLinked) {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏á alert ‡πÉ‡∏ô‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
        html += `<div class="alert bg-emerald-50 border border-emerald-300 text-emerald-800 mb-4">
            <div class="text-sm">
                <p><strong>üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Material:</strong> 
                   <span class="font-mono bg-cyan-100 border border-cyan-300 px-2 py-1 rounded text-cyan-800">{{ form.linked_material_name if form and form.linked_material_name else 'N/A' }}</span>
                </p>
                <p><strong>üìä Scope:</strong> <span class="text-teal-700">{{ form.ghg_scope if form else 'N/A' }}</span> | <strong>Sub-Scope:</strong> <span class="text-teal-700">{{ form.ghg_sup_scope if form else 'N/A' }}</span></p>
                <p class="text-xs text-emerald-700 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
        </div>`;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô
        html += `<div class="mb-6">
            <label class="block text-sm text-blue-800 mb-1">
                <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) (unit)</strong>
            </label>
            <div class="relative">
                <input type="number" class="input input-bordered w-full mb-2 bg-cyan-50 border-cyan-200" 
                       value="[‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å {{ form.linked_material_name }}]" readonly>
                <div class="flex gap-2 mt-2">
                    <div class="text-xs text-teal-800 bg-teal-100 border border-teal-300 rounded-full px-3 py-1 inline-block">Field: buffer_data</div>
                    <div class="text-xs text-emerald-800 bg-emerald-100 border-emerald-300 rounded-full px-3 py-1 inline-block">Type: auto-generated</div>
                </div>
            </div>
        </div>`;
    } else {
        const descForm = document.querySelector("textarea[name='desc_form']").value || "No Description";
        const mainScope = document.querySelector("select[name='scope']").value || "-";
        const subScope = document.querySelector("select[name='sup_scope']").value || "-";
        
        html += `<div class="mb-4">
            <p class="text-sm text-gray-600">{{ t.material_name }}: ${materialName}</p>
            <p class="text-sm text-gray-600">{{ t.form_description }}: ${descForm}</p>
            <div class="flex gap-4 mt-2">
                <div class="text-xs text-gray-700 bg-purple-100 rounded-full px-3 py-1 inline-block">Main Scope: ${mainScope}</div>
                <div class="text-xs text-gray-700 bg-indigo-100 rounded-full px-3 py-1 inline-block">Sub Scope: ${subScope}</div>
                <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥</div>
            </div>
        </div>`;

        // Show input fields for normal form
        if (container) {
            const fields = container.querySelectorAll("[data-index]");
            fields.forEach(row => {
                const field = row.querySelector("input[name='field']").value;
                const label = row.querySelector("input[name='label']").value;
                const inputType = row.querySelector("select[name='input_type']").value;
                const unit = row.querySelector("input[name='unit']").value;
                html += `<div class='mb-6'>
                    <label class='block text-sm text-gray-800 mb-1'><strong>${label || field} (${unit || '-'})</strong></label>
                    <div class="relative">
                        <input type='${inputType}' class='input input-bordered w-full mb-2' placeholder='{{t.enter}} ${label || field}'>
                        <div class="flex gap-2 mt-2">
                            <div class="text-xs text-gray-700 bg-gray-200 rounded-full px-3 py-1 inline-block">Field: ${field || "Unnamed Field"}</div>
                            <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">Type: ${inputType}</div>
                        </div>
                    </div>
                </div>`;
            });
        }
    }

    const formula = document.querySelector("input[name='formula']").value || "No Formula";
    const descFormula = document.querySelector("textarea[name='desc_formula']").value || "No Formula Description";
    html += `<div class="mt-6">
        <p class="text-sm text-gray-600">{{ t.formula }}: ${formula}</p>
        <p class="text-sm text-gray-600">{{ t.formula_description }}: ${descFormula}</p>
    </div>`;

    const currentUser = "{{ current_user.username if current_user else 'Unknown User' }}";
    const currentTime = new Date().toLocaleString();
    html += `<div class="mt-6 text-xs text-gray-500">
        <div class="flex items-center gap-2"><i data-feather="user" class="w-4 h-4"></i><span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢: ${currentUser}</span></div>
        <div class="flex items-center gap-2 mt-2"><i data-feather="clock" class="w-4 h-4"></i><span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${currentTime}</span></div>
    </div>`;

    preview.innerHTML = html || `<p class="italic text-sm text-gray-500">No fields added.</p>`;
    feather.replace();
}

function confirmDelete(formId, materialName) {
    if (confirm(`Are you sure you want to delete "${materialName}"?\n\nThis action cannot be undone.`)) {
        fetch(`{{ url_for('form_management.delete_form', form_id='') }}${formId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modal').classList.remove('modal-open');
                setTimeout(() => {
                    location.reload();
                }, 300);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred while deleting the form');
        });
    }
}

// Functions ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°...
function toggleFormType() {
    const formType = document.querySelector('input[name="form_type"]:checked').value;
    const linkedSection = document.getElementById('linked-material-section');
    const inputFieldsSection = document.getElementById('input-fields-section');
    
    if (formType === 'linked') {
        linkedSection.classList.remove('hidden');
        inputFieldsSection.classList.add('hidden');
        
        // ‡πÇ‡∏´‡∏•‡∏î available materials ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ scope ‡πÅ‡∏•‡∏∞ sub scope
        triggerLinkedMaterialsLoad();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ formula ‡πÄ‡∏õ‡πá‡∏ô buffer_data * 1 ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        const formulaInput = document.getElementById('formula');
        if (!formulaInput.value || formulaInput.value === '') {
            formulaInput.value = 'buffer_data * 1';
        }
        updatePreview();
    } else {
        linkedSection.classList.add('hidden');
        inputFieldsSection.classList.remove('hidden');
        updatePreview();
    }
}

function triggerLinkedMaterialsLoad() {
    const formType = document.querySelector('input[name="form_type"]:checked')?.value;
    if (formType !== 'linked') return;
    
    const scope = document.querySelector('select[name="scope"]').value;
    const subScope = document.querySelector('select[name="sup_scope"]').value;
    
    if (scope && subScope) {
        // ‡πÉ‡∏ä‡πâ HTMX ‡πÇ‡∏´‡∏•‡∏î available materials
        htmx.ajax('GET', `/form-management/get-available-materials/${scope}/${subScope}`, {
            target: '#available-materials-container',
            swap: 'innerHTML'
        });
    }
}

// Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HTMX
document.addEventListener('htmx:afterSettle', function(event) {
    if (event.detail.target.id === 'available-materials-container') {
        feather.replace();
        updatePreview();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ selected value ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const form = {{ form|tojson if form else 'null' }};
        if (form && form.is_linked && form.linked_material_name) {
            const select = document.querySelector('select[name="linked_material_name"]');
            if (select) {
                select.value = form.linked_material_name;
            }
        }
    }
    if (event.detail.target.id === 'sub-scope-container') {
        triggerLinkedMaterialsLoad();
        updatePreview();
    }
});

document.addEventListener("htmx:afterSettle", function(event) {
    console.log("HTMX afterSettle triggered for:", event.detail.target);
    
    if (event.detail.target.querySelector('input[name="form_id"]')) {
        console.log("Edit form modal loaded, initializing...");
        feather.replace();
        setTimeout(() => {
            initializeForm();
        }, 100);
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î sub-scope container
    if (event.detail.target.id === 'sub-scope-container' || 
        event.detail.target.closest('#sub-scope-container') ||
        event.detail.target.querySelector('select[name="sup_scope"]')) {
        console.log("Sub scope container loaded/updated");
        setTimeout(() => {
            updatePreview();
            feather.replace();
        }, 50);
    }
});

// Initialize when DOM loads
document.addEventListener("DOMContentLoaded", function() {
    if (document.querySelector('input[name="form_id"]')) {
        console.log("Edit form DOM ready, initializing...");
        feather.replace();
        initializeForm();
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ updateCalculatorButtons ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        setTimeout(() => {
            updateCalculatorButtons();
            console.log("Calculator buttons initialized for linked form");
        }, 1000);
    }
});
</script>