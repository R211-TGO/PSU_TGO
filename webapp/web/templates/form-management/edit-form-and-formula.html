<div class="max-w-6xl mx-auto px-6 py-8">
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Left: Edit Form Field -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <h3 class="text-black-600 font-bold text-lg mb-4 border-b border-b-gray-200 pb-3">{{ t.edit_form_field }}</h3>
      <form method="POST" action="{{ url_for('form_management.edit_form_and_formula') }}">
        <input type="hidden" name="form_id" value="{{ form.id if form else '' }}">

        <!-- Form Metadata -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-font">{{ t.form_name }}</label>
            <input 
              type="text" 
              name="name" 
              class="input input-bordered w-full mt-1" 
              placeholder="Enter form name" 
              value="{{ form.name if form else '' }}" 
              oninput="updatePreview()" 
              required>
          </div>

          <div>
            <label class="text-font">{{ t.material_name }}</label>
            <input 
              type="text" 
              name="material_name" 
              class="input input-bordered w-full mt-1" 
              placeholder="Enter material name" 
              value="{{ form.material_name if form else '' }}" 
              oninput="updatePreview()" 
              required>
          </div>

          <!-- เพิ่ม Main Scope Selection -->
          <div>
            <label class="text-font">Main Scope</label>
            <select 
              name="scope" 
              id="main-scope"
              class="select select-bordered w-full mt-1" 
              hx-get="/form-management/get-sub-scopes/"
              hx-target="#sub-scope-container"
              hx-trigger="change"
              hx-include="[name='scope']"
              onchange="updatePreview()"
              required>
              <option value="">เลือก Main Scope</option>
              <option value="1" {{ 'selected' if form and form.ghg_scope == 1 else '' }}>Scope 1</option>
              <option value="2" {{ 'selected' if form and form.ghg_scope == 2 else '' }}>Scope 2</option>
              <option value="3" {{ 'selected' if form and form.ghg_scope == 3 else '' }}>Scope 3</option>
            </select>
          </div>

          <!-- เพิ่ม Sub Scope Selection -->
          <div>
            <label class="text-font">Sub Scope</label>
            <div id="sub-scope-container">
              {% if form and form.ghg_scope and form.ghg_sup_scope %}
                <!-- Load existing sub scope with selected value -->
                <div hx-get="/form-management/get-sub-scopes/{{ form.ghg_scope }}?selected={{ form.ghg_sup_scope }}"
                     hx-trigger="load once, refreshSubScope from:body"
                     hx-target="this"
                     hx-swap="outerHTML">
                  <select name="sup_scope" class="select select-bordered w-full mt-1" required>
                    <option value="{{ form.ghg_sup_scope }}" selected>{{ form.ghg_sup_scope }} - กำลังโหลด...</option>
                  </select>
                </div>
              {% elif form and form.ghg_scope %}
                <!-- Load sub scopes for existing scope without selection -->
                <div hx-get="/form-management/get-sub-scopes/{{ form.ghg_scope }}"
                     hx-trigger="load once, refreshSubScope from:body"
                     hx-target="this"
                     hx-swap="outerHTML">
                  <select name="sup_scope" class="select select-bordered w-full mt-1" required>
                    <option value="">กำลังโหลด Sub Scopes...</option>
                  </select>
                </div>
              {% else %}
                <select name="sup_scope" class="select select-bordered w-full mt-1" required>
                  <option value="">เลือก Main Scope ก่อน</option>
                </select>
              {% endif %}
            </div>
          </div>

          <div class="sm:col-span-2">
            <label class="text-font">{{ t.form_description }}</label>
            <textarea 
              name="desc_form" 
              class="textarea textarea-bordered w-full mt-1" 
              placeholder="Enter form description" 
              oninput="updatePreview()"
            >{{ form.desc_form if form else '' }}</textarea>
          </div>
        </div>

        <!-- Define Input Fields -->
        <div class="mt-6">
          <label class="text-font">{{ t.define_input_fields }}</label>
          <div id="input-fields-container" class="space-y-4">
            <!-- ฟิลด์ที่เพิ่มจะถูกแทรกที่นี่ -->
          </div>
          <!-- ปุ่ม Add Input Field -->
          <button 
            type="button" 
            class="btn btn-outline btn-lg mt-2 w-full border-dashed flex items-center justify-center gap-3 py-4 bg-gray-50 hover:bg-gray-100 text-gray-600 text-sm" 
            onclick="addInputField()">
            <i data-feather="plus" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- Formula Section -->
        <div class="mt-6">
          <label class="text-font">{{t.formula}}</label>
          <div class="relative mb-4">
            <div class="flex">
              <input 
                type="text" 
                name="formula" 
                id="formula" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. diesel * 2.68" 
                value="{{ form.formula if form else '' }}"
                readonly 
                required
                onclick="toggleFormulaCalculator()">
              
              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormulaCalculator()"
                      title="Open Formula Calculator">
                <i data-feather="grid" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>
            
            <!-- Formula Calculator Dropdown -->
            <div id="formula-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{t.formula_builder}}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormulaCalculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>

              <!-- Variables Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.variables }}</h5>
                <div class="grid grid-cols-4 gap-2" id="variables-buttons">
                  <!-- ปุ่มตัวแปรจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.numbers }}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers-buttons">
                  <!-- ปุ่มตัวเลขจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.operators }}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators-buttons">
                  <!-- ปุ่มสัญลักษณ์ทางคณิตศาสตร์จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormulaCalculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Formula 2 Section -->
        <div class="mt-6">
          <label class="text-font">{{ t.formula_2 }} ({{ t.advanced_calculation }})</label>
          <div class="relative mb-4">
            <div class="flex ">
              <input 
                type="text" 
                name="formula2" 
                id="formula2" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. result * 2.5 + result * carbon_factor" 
                value="{{ form.formula2 if form else '' }}"
                readonly
                onclick="toggleFormula2Calculator()">

              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula2-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormula2Calculator()"
                      title="Open Formula 2 Calculator">
                <i data-feather="trending-up" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>

            <!-- Formula 2 Calculator Dropdown -->
            <div id="formula2-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{ t.formula_2_builder }}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormula2Calculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>
              <p class="text-sm text-gray-500 mb-3">{{ t.use_result_from_formula_1 }}</p>

              <!-- Result Variable Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.result_variable }}</h5>
                <div class="grid grid-cols-1 gap-2" id="result-buttons">
                  <button type="button" class="btn btn-sm btn-outline bg-green-100 text-green-800" onclick="addToFormula2('result')">result</button>
                </div>
              </div>

              <!-- Constants Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.constants }}</h5>
                <div class="grid grid-cols-3 gap-2" id="constants-buttons">
                  <!-- ปุ่มค่าคงที่จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{t.number}}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers2-buttons">
                  <!-- ปุ่มตัวเลขจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{t.operators}}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators2-buttons">
                  <!-- ปุ่มสัญลักษณ์ทางคณิตศาสตร์จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormula2Calculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula2()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_description }}</label>
          <textarea 
            name="desc_formula" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_description }}" 
            oninput="updatePreview()"
          >{{ form.desc_formula if form else '' }}</textarea>
        </div>

        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_2_description }}</label>
          <textarea 
            name="desc_formula2" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_2_description }}" 
            oninput="updatePreview()"
          >{{ form.desc_formula2 if form else '' }}</textarea>
        </div>

        <!-- เพิ่มส่วนนี้ที่ด้านบนของฟอร์ม -->
        {% if error_msg %}
        <div class="alert alert-error mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ error_msg }}</span>
        </div>
        {% endif %}

        <div class="mt-6 flex justify-between">
          <!-- ปุ่มลบ - เปลี่ยนเป็น style เหมือน Sign Out -->
          <button type="button" class="btn btn-outline btn-error" onclick="confirmDelete('{{ form.id }}', '{{ form.name }}')">
            {{t.delete_form}}
          </button>
          
          <!-- ปุ่มบันทึกและยกเลิก -->
          <div class="flex gap-3">
            <button type="button" class="btn btn-outline" onclick="document.getElementById('modal').classList.remove('modal-open')">{{t.cancel}}</button>
            <button type="submit" class="btn btn-primary">{{t.save_changes}}</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Right: Form Preview -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <h3 class="text-black-600 font-bold text-lg mb-4">{{ t.form_preview }}</h3>
      <div id="form-preview" class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
        <p class="italic text-sm text-gray-500">Input fields preview will appear here...</p>
      </div>
    </div>
  </div>
</div>

<!-- เพิ่ม shared JavaScript -->
<script src="{{ url_for('static', filename='js/form-calculator.js') }}"></script>

<script>
function initializeForm() {
    console.log("Initializing edit form...");
    
    inputFieldCount = 0;
    currentFormula = '';
    currentFormula2 = '';
    
    const container = document.getElementById("input-fields-container");
    if (container) {
        container.innerHTML = "";
    }
    
    const formIdInput = document.querySelector("input[name='form_id']");
    const formId = formIdInput ? formIdInput.value : null;
    
    if (formId) {
        console.log("Loading form data for ID:", formId);
        fetch(`/form-management/get-form-data/${formId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Form data loaded successfully:", data.form);
                    loadFormData(data.form);
                } else {
                    console.error("Failed to load form data:", data.message);
                    addInputField();
                    setTimeout(() => {
                        updatePreview();
                        updateFormulaButtons();
                        updateFormula2Buttons();
                        feather.replace();
                    }, 100);
                }
            })
            .catch(error => {
                console.error("Error loading form data:", error);
                addInputField();
                setTimeout(() => {
                    updatePreview();
                    updateFormulaButtons();
                    updateFormula2Buttons();
                    feather.replace();
                }, 100);
            });
    } else {
        console.log("No form ID found, adding default field");
        addInputField();
        setTimeout(() => {
            updatePreview();
            updateFormulaButtons();
            updateFormula2Buttons();
            feather.replace();
        }, 100);
    }
}

function loadFormData(formData) {
    console.log("Loading form data:", formData);
    
    const container = document.getElementById("input-fields-container");
    if (container) {
        container.innerHTML = "";
    }
    
    inputFieldCount = 0;
    
    if (formData.input_types && formData.input_types.length > 0) {
        formData.input_types.forEach(inputField => {
            addInputField({
                field: inputField.field,
                label: inputField.label,
                input_type: inputField.input_type,
                unit: inputField.unit
            });
        });
    } else {
        addInputField();
    }
    
    setTimeout(() => {
        // โหลดข้อมูลพื้นฐาน
        if (formData.name) {
            const nameInput = document.querySelector("input[name='name']");
            if (nameInput) nameInput.value = formData.name;
        }
        if (formData.material_name) {
            const materialInput = document.querySelector("input[name='material_name']");
            if (materialInput) materialInput.value = formData.material_name;
        }
        if (formData.desc_form) {
            const descFormTextarea = document.querySelector("textarea[name='desc_form']");
            if (descFormTextarea) descFormTextarea.value = formData.desc_form;
        }
        if (formData.formula) {
            const formulaInput = document.querySelector("input[name='formula']");
            if (formulaInput) formulaInput.value = formData.formula;
        }
        if (formData.formula2) {
            const formula2Input = document.querySelector("input[name='formula2']");
            if (formula2Input) formula2Input.value = formData.formula2;
        }
        if (formData.desc_formula) {
            const descFormulaTextarea = document.querySelector("textarea[name='desc_formula']");
            if (descFormulaTextarea) descFormulaTextarea.value = formData.desc_formula;
        }
        if (formData.desc_formula2) {
            const descFormula2Textarea = document.querySelector("textarea[name='desc_formula2']");
            if (descFormula2Textarea) descFormula2Textarea.value = formData.desc_formula2;
        }
        
        // โหลด scope ข้อมูล
        if (formData.ghg_scope) {
            const mainScopeSelect = document.querySelector("select[name='scope']");
            if (mainScopeSelect) {
                mainScopeSelect.value = formData.ghg_scope;
                console.log(`Set main scope to: ${formData.ghg_scope}`);
            }
        }
        
        // Trigger การโหลด sub scope ใหม่
        setTimeout(() => {
            console.log("Triggering sub scope refresh...");
            htmx.trigger(document.body, 'refreshSubScope');
            
            setTimeout(() => {
                updatePreview();
                updateFormulaButtons();
                updateFormula2Buttons();
                feather.replace();
            }, 200);
        }, 100);
    }, 50);
}

function updatePreview() {
    const container = document.getElementById("input-fields-container");
    const preview = document.getElementById("form-preview");
    const fields = container.querySelectorAll("[data-index]");
    let html = "";

    const materialName = (document.querySelector("input[name='material_name']").value || "NO MATERIAL NAME").toUpperCase();

    html += `
    <div class="mb-6">
        <p class="text-sm text-gray-400"><strong>{{ t.material_name|upper }}:</strong> ${materialName}</p>
    </div>`;

    const formName = document.querySelector("input[name='name']").value || "Untitled Form";
    const descForm = document.querySelector("textarea[name='desc_form']").value || "No Description";
    
    const mainScope = document.querySelector("select[name='scope']").value || "-";
    const subScope = document.querySelector("select[name='sup_scope']").value || "-";

    html += `
    <div class="mb-4">
        <p class="text-sm text-gray-600">{{ t.form_name }}: ${formName}</p>
        <p class="text-sm text-gray-600">{{ t.form_description }}: ${descForm}</p>
        <div class="flex gap-4 mt-2">
            <div class="text-xs text-gray-700 bg-purple-100 rounded-full px-3 py-1 inline-block">
                Main Scope: ${mainScope}
            </div>
            <div class="text-xs text-gray-700 bg-indigo-100 rounded-full px-3 py-1 inline-block">
                Sub Scope: ${subScope}
            </div>
        </div>
    </div>`;

    fields.forEach(row => {
        const field = row.querySelector("input[name='field']").value;
        const label = row.querySelector("input[name='label']").value;
        const inputType = row.querySelector("select[name='input_type']").value;
        const unit = row.querySelector("input[name='unit']").value;

        html += `<div class='mb-6'>
            <label class='block text-sm text-gray-800 mb-1'><strong>${label || field} (${unit || '-'})</strong></label>
            <div class="relative">
                <input type='${inputType}' class='input input-bordered w-full mb-2' placeholder='{{t.enter}} ${label || field}'>
                <div class="flex gap-2 mt-2">
                    <div class="text-xs text-gray-700 bg-gray-200 rounded-full px-3 py-1 inline-block">
                        Field: ${field || "Unnamed Field"}
                    </div>
                    <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">
                        Type: ${inputType}
                    </div>
                </div>
            </div>
        </div>`;
    });

    const formula = document.querySelector("input[name='formula']").value || "No Formula";
    const descFormula = document.querySelector("textarea[name='desc_formula']").value || "No Formula Description";
    const formula2 = document.querySelector("input[name='formula2']").value || "";
    const descFormula2 = document.querySelector("textarea[name='desc_formula2']").value || "";

    html += `
        <div class="mt-6">
            <p class="text-sm text-gray-600">{{ t.formula }}: ${formula}</p>
            <p class="text-sm text-gray-600">{{ t.formula_description }}: ${descFormula}</p>
        </div>`;

    if (formula2) {
        html += `
        <div class="mt-4">
            <p class="text-sm text-gray-600">{{ t.formula_2 }}: ${formula2}</p>
            <p class="text-sm text-gray-600">{{ t.formula_2_description }}: ${descFormula2}</p>
        </div>`;
    }

    const currentUser = "{{ current_user.username if current_user else 'Unknown User' }}";
    const currentTime = new Date().toLocaleString();

    html += `
    <div class="mt-6 text-xs text-gray-500">
        <div class="flex items-center gap-2">
            <i data-feather="user" class="w-4 h-4"></i>
            <span>แก้ไขโดย: ${currentUser}</span>
        </div>
        <div class="flex items-center gap-2 mt-2">
            <i data-feather="clock" class="w-4 h-4"></i>
            <span>แก้ไขเมื่อ: ${currentTime}</span>
        </div>
    </div>`;

    preview.innerHTML = html || `<p class="italic text-sm text-gray-500">No fields added.</p>`;
    feather.replace();
}

function confirmDelete(formId, formName) {
    if (confirm(`Are you sure you want to delete "${formName}"?\n\nThis action cannot be undone.`)) {
        fetch(`{{ url_for('form_management.delete_form', form_id='') }}${formId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modal').classList.remove('modal-open');
                setTimeout(() => {
                    location.reload();
                }, 300);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred while deleting the form');
        });
    }
}

document.addEventListener("htmx:afterSettle", function(event) {
    console.log("HTMX afterSettle triggered for:", event.detail.target);
    
    if (event.detail.target.querySelector('input[name="form_id"]')) {
        console.log("Edit form modal loaded, initializing...");
        feather.replace();
        setTimeout(() => {
            initializeForm();
        }, 100);
    }
    
    // ถ้าเป็นการโหลด sub-scope container
    if (event.detail.target.id === 'sub-scope-container' || 
        event.detail.target.closest('#sub-scope-container') ||
        event.detail.target.querySelector('select[name="sup_scope"]')) {
        console.log("Sub scope container loaded/updated");
        setTimeout(() => {
            updatePreview();
            feather.replace();
        }, 50);
    }
});

document.addEventListener("DOMContentLoaded", function() {
    if (document.querySelector('input[name="form_id"]')) {
        console.log("Edit form DOM ready, initializing...");
        feather.replace();
        initializeForm();
    }
});
</script>