<div class="max-w-6xl mx-auto px-6 py-8">
  <!-- ปุ่มปิดป็อปอัพทั้งหมด -->
  <div class="flex justify-end mb-4">
  <button type="button" 
          class="btn btn-sm btn-ghost text-gray-700 hover:text-gray-900 hover:bg-gray-100" 
          onclick="document.getElementById('modal').classList.remove('modal-open');"
          title="ปิดป็อปอัพ">
    <i data-feather="x" class="h-5 w-5 mr-1"></i>
  </button>
</div>

  <!-- Checkbox สำหรับ toggle preview (ซ่อนไว้) -->
  <input type="checkbox" id="preview-toggle" class="hidden" checked>

  <!-- เปลี่ยนจาก grid เป็น main-container -->
  <div class="main-container">
    <!-- Left: Edit Form Field -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-gray-800 font-bold text-lg border-b border-b-gray-200 pb-3">{{ t.edit_form_field }}</h3>
        <!-- ปุ่ม toggle พรีวิว -->
        <label for="preview-toggle" class="btn btn-sm btn-ghost text-gray-600 hover:text-gray-800 hover:bg-gray-100 cursor-pointer" title="เปิด/ปิดพรีวิว">
          <i data-feather="eye" class="h-5 w-5 mr-1"></i>
          ซ่อนพรีวิว
        </label>
      </div>
      
      <!-- ฟอร์มเนื้อหาเดิมทั้งหมดไม่เปลี่ยน... -->
      <form method="POST" action="{{ url_for('form_management.edit_form_and_formula') }}" onsubmit="submitEditForm(event)">
        <input type="hidden" name="form_id" value="{{ form.id if form else '' }}">

        <!-- Form Metadata -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

          <div>
            <label class="text-font">{{ t.material_name }}</label>
            <input 
              type="text" 
              name="material_name" 
              class="input input-bordered w-full mt-1" 
              placeholder="Enter material name" 
              value="{{ form.material_name if form else '' }}" 
              oninput="updatePreview()" 
              required>
          </div>

          <!-- Main Scope Selection -->
          <div>
            <label class="text-font">Main Scope</label>
            <select 
              name="scope" 
              id="main-scope"
              class="select select-bordered w-full mt-1 cursor-not-allowed bg-gray-50" 
              disabled>
              <option value="">เลือก Main Scope</option>
              <option value="1" {{ 'selected' if form and form.ghg_scope == 1 else '' }}>Scope 1</option>
              <option value="2" {{ 'selected' if form and form.ghg_scope == 2 else '' }}>Scope 2</option>
              <option value="3" {{ 'selected' if form and form.ghg_scope == 3 else '' }}>Scope 3</option>
            </select>
            <input type="hidden" name="scope" value="{{ form.ghg_scope if form else '' }}">
          </div>

          <!-- Sub Scope Selection -->
          <div>
            <label class="text-font">Sub Scope</label>
            <div id="sub-scope-container">
              <select name="sup_scope" class="select select-bordered w-full mt-1 cursor-not-allowed bg-gray-50" disabled>
                {% if form and form.ghg_sup_scope %}
                  <option value="{{ form.ghg_sup_scope }}" selected>{{ form.ghg_sup_scope }}</option>
                {% else %}
                  <option value="">ไม่มีข้อมูล Sub Scope</option>
                {% endif %}
              </select>
              <input type="hidden" name="sup_scope" value="{{ form.ghg_sup_scope if form else '' }}">
            </div>
          </div>

          <div class="sm:col-span-2">
            <label class="text-font">{{ t.form_description }}</label>
            <textarea 
              name="desc_form" 
              class="textarea textarea-bordered w-full mt-1" 
              placeholder="Enter form description" 
              oninput="updatePreview()"
            >{{ form.desc_form if form else '' }}</textarea>
          </div>
        </div>

        <!-- Define Input Fields -->
        {% if not (form and form.is_linked) %}
        <div class="mt-6">
          <label class="text-font">{{ t.define_input_fields }}</label>
          <div id="input-fields-container" class="space-y-4">
            <!-- ฟิลด์ที่เพิ่มจะถูกแทรกที่นี่ -->
          </div>
          <!-- ปุ่ม Add Input Field -->
          <button 
            type="button" 
            class="btn btn-outline btn-lg mt-2 w-full border-dashed flex items-center justify-center gap-3 py-4 bg-gray-50 hover:bg-gray-100 text-gray-600 text-sm" 
            onclick="addInputField()">
            <i data-feather="plus" class="w-6 h-6"></i>
            {{ t.add_input_field }}
          </button>
        </div>
        {% else %}
        <div class="mt-6">
          <div class="alert bg-blue-50 border border-blue-300 text-blue-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold text-blue-800">ข้อมูลการเชื่อมโยง</h3>
              <div class="text-sm mt-2" id="linked-info">
                <p><strong>เชื่อมโยงกับ Material:</strong> <span class="font-mono bg-gray-100 border border-gray-300 px-2 py-1 rounded text-gray-800">{{ form.linked_material_name }}</span></p>
                <p class="mt-1"><strong>Scope:</strong> <span class="text-blue-700" id="linked-scope">{{ form.ghg_scope }}</span> | <strong>Sub-Scope:</strong> <span class="text-blue-700" id="linked-sub-scope">{{ form.ghg_sup_scope }}</span></p>
                <p class="text-xs text-blue-700 mt-2">ระบบจะดึงข้อมูลจาก Material ดังกล่าวโดยอัตโนมัติ</p>
              </div>
            </div>
          </div>
          
          <!-- แสดงฟิลด์ที่จะถูกสร้างอัตโนมัติ -->
          <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
            <h4 class="text-sm font-medium text-gray-800 mb-3">ฟิลด์ที่สร้างอัตโนมัติ</h4>
            <div id="linked-fields-preview">
              <!-- ฟิลด์จะถูกโหลดจาก JavaScript -->
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Formula Section -->
        <div class="mt-6">
          <label class="text-font">{{t.formula}}</label>
          <div class="relative mb-4">
            <div class="flex">
              <input 
                type="text" 
                name="formula" 
                id="formula" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. diesel * 2.68" 
                value="{{ form.formula if form else '' }}"
                readonly 
                required
                onclick="toggleFormulaCalculator()">
              
              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormulaCalculator()"
                      title="Open Formula Calculator">
                <i data-feather="grid" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>
            
            <!-- Formula Calculator Dropdown -->
            <div id="formula-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{t.formula_builder}}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormulaCalculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>

              <!-- Variables Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-700 mb-2">{{ t.variables }}</h5>
                <div class="grid grid-cols-4 gap-2" id="variables-buttons">
                  <!-- ปุ่มตัวแปรจะถูกเพิ่มที่นี่ -->
                </div>
                {% if form and form.is_linked %}
                <p class="text-xs text-blue-600 mt-2">
                  ใช้ตัวแปรจาก Material: <strong class="text-blue-700">{{ form.linked_material_name }}</strong>
                </p>
                {% endif %}
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.numbers }}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers-buttons">
                  <!-- ปุ่มตัวเลขจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.operators }}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators-buttons">
                  <!-- ปุ่มสัญลักษณ์ทางคณิตศาสตร์จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormulaCalculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Formula Description -->
        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_description }}</label>
          <textarea 
            name="desc_formula" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_description }}" 
            oninput="updatePreview()"
          >{{ form.desc_formula if form else '' }}</textarea>
        </div>

        <div class="mt-6 flex justify-between">
          <!-- ปุ่มลบ -->
          <button type="button" class="btn btn-outline btn-error" onclick="confirmDelete('{{ form.id }}', '{{ form.material_name }}')">
            {{t.delete_form}}
          </button>
          
          <!-- ปุ่มบันทึกและยกเลิก -->
          <div class="flex gap-3">
            <button type="button" class="btn btn-outline" onclick="document.getElementById('modal').classList.remove('modal-open')">{{t.cancel}}</button>
            <button type="submit" class="btn btn-primary">{{t.save_changes}}</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Right: Form Preview -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6 transition-all duration-300 preview-panel">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-gray-800 font-bold text-lg">{{ t.form_preview }}</h3>
        <label for="preview-toggle" class="btn btn-sm btn-ghost text-gray-500 hover:text-gray-700 hover:bg-gray-100 cursor-pointer" title="ปิดพรีวิว">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </label>
      </div>
      <div id="form-preview" class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
        <!-- พรีวิวเนื้อหาเดิม -->
      </div>
    </div>
  </div>
</div>

<!-- เพิ่ม CSS สำหรับปุ่มซ่อนพรีวิว -->
<style>
/* Grid layout หลัก */
.main-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  transition: all 0.3s ease-in-out;
}

/* เมื่อ checkbox ไม่ถูกเลือก (ปิดพรีวิว) */
#preview-toggle:not(:checked) ~ .main-container {
  grid-template-columns: 1fr 0fr !important;
}

#preview-toggle:not(:checked) ~ .main-container .preview-panel {
  width: 0 !important;
  min-width: 0 !important;
  opacity: 0 !important;
  overflow: hidden !important;
  padding: 0 !important;
  margin: 0 !important;
  border: none !important;
}

/* เปลี่ยนข้อความปุ่ม */
#preview-toggle:checked ~ .main-container .toggle-text::before {
  content: "ซ่อนพรีวิว";
}

#preview-toggle:not(:checked) ~ .main-container .toggle-text::before {
  content: "แสดงพรีวิว";
}

.toggle-text {
  display: none;
}

.toggle-text::before {
  display: inline;
}

/* Smooth transitions */
.preview-panel,
.main-container {
  transition: all 0.3s ease-in-out;
}

/* Responsive */
@media (max-width: 1280px) {
  .main-container {
    grid-template-columns: 1fr !important;
  }
  
  #preview-toggle:not(:checked) ~ .main-container .preview-panel {
    display: none !important;
  }
}

/* ปรับให้ form section ขยายเต็มพื้นที่เมื่อปิดพรีวิว */
#preview-toggle:not(:checked) ~ .main-container > div:first-child {
  width: 100% !important;
  max-width: none !important;
}
</style>

<!-- JavaScript เดิมทั้งหมดไม่เปลี่ยน -->
<script src="{{ url_for('static', filename='js/form-calculator.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Global variables for linked material data
let linkedMaterialData = null;

// เพิ่ม functions สำหรับ formula calculator
function addToFormula(value) {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        const currentValue = formulaInput.value || "";
        formulaInput.value = currentValue + value;
        updatePreview();
    }
}

function clearFormula() {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        formulaInput.value = "";
        updatePreview();
    }
}

function toggleFormulaCalculator() {
    const calculator = document.getElementById("formula-calculator");
    const dropdownBtn = document.getElementById("formula-dropdown-btn");
    
    if (calculator.classList.contains("hidden")) {
        calculator.classList.remove("hidden");
        const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
        if (chevron) chevron.style.transform = "rotate(180deg)";
        
        // อัปเดตปุ่มเครื่องคิดเลข
        updateCalculatorButtons();
    } else {
        calculator.classList.add("hidden");
        const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
        if (chevron) chevron.style.transform = "rotate(0deg)";
    }
}

function closeFormulaCalculator() {
    const calculator = document.getElementById("formula-calculator");
    const dropdownBtn = document.getElementById("formula-dropdown-btn");
    
    calculator.classList.add("hidden");
    const chevron = dropdownBtn.querySelector("i[data-feather='chevron-down']");
    if (chevron) chevron.style.transform = "rotate(0deg)";
}

function applyFormula() {
    closeFormulaCalculator();
    updatePreview();
}

// ฟังก์ชันใหม่สำหรับโหลดข้อมูล linked material
async function loadLinkedMaterialData(materialName) {
    try {
        const response = await fetch(`/form-management/get-linked-material-data/${encodeURIComponent(materialName)}`);
        if (response.ok) {
            linkedMaterialData = await response.json();
            updateLinkedDisplay();
            return linkedMaterialData;
        }
    } catch (error) {
        console.error('Error loading linked material data:', error);
    }
    return null;
}

function updateLinkedDisplay() {
    if (!linkedMaterialData) return;
    
    // อัปเดตข้อมูล scope และ sub-scope
    const scopeElement = document.getElementById('linked-scope');
    const subScopeElement = document.getElementById('linked-sub-scope');
    
    if (scopeElement) scopeElement.textContent = linkedMaterialData.ghg_scope;
    if (subScopeElement) subScopeElement.textContent = linkedMaterialData.ghg_sup_scope;
    
    // อัปเดตฟิลด์ในส่วน preview
    updateLinkedFieldsPreview();
}

function updateLinkedFieldsPreview() {
    const container = document.getElementById('linked-fields-preview');
    if (!container || !linkedMaterialData) return;
    
    let html = '';
    linkedMaterialData.input_types.forEach((inputType, index) => {
        html += `
            <div class="mb-3">
                <label class="block text-sm text-gray-700 mb-1">
                    <strong>${inputType.label || inputType.field} (${inputType.unit || 'unit'})</strong>
                </label>
                <input type="${inputType.input_type}" 
                       class="input input-bordered w-full text-sm bg-gray-50 border-gray-200" 
                       value="[ข้อมูลจาก ${linkedMaterialData.material_name}]" 
                       readonly>
                <div class="flex gap-2 mt-1">
                    <div class="text-xs text-gray-600 bg-gray-100 border border-gray-200 rounded-full px-2 py-1 inline-block">Field: ${inputType.field}</div>
                    <div class="text-xs text-blue-600 bg-blue-100 border border-blue-200 rounded-full px-2 py-1 inline-block">Type: ${inputType.input_type}</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateCalculatorButtons() {
    const isLinked = {{ 'true' if form and form.is_linked else 'false' }};
    
    console.log("Updating calculator buttons, isLinked:", isLinked);
    
    // สร้างปุ่มตัวแปร
    updateVariableButtons();
    
    // สร้างปุ่มตัวเลข (ทั้งฟอร์มปกติและลิงก์)
    populateNumbersButtons();
    
    // สร้างปุ่มตัวดำเนินการ (ทั้งฟอร์มปกติและลิงก์)
    populateOperatorsButtons();
}

function updateVariableButtons() {
    const variablesButtons = document.getElementById("variables-buttons");
    if (!variablesButtons) return;
    
    variablesButtons.innerHTML = "";
    
    const isLinked = {{ 'true' if form and form.is_linked else 'false' }};
    
    if (isLinked && linkedMaterialData) {
        // ใช้ตัวแปรจาก linked material
        linkedMaterialData.input_types.forEach(inputType => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn btn-xs border border-blue-300 text-blue-700 bg-blue-50 hover:bg-blue-100";
            button.textContent = inputType.field;
            button.onclick = () => addToFormula(inputType.field);
            variablesButtons.appendChild(button);
        });
    } else {
        // ฟอร์มปกติ - ใช้ตัวแปรจาก input fields
        const container = document.getElementById("input-fields-container");
        if (!container) return;
        
        const fieldInputs = container.querySelectorAll("input[name='field']");
        fieldInputs.forEach(input => {
            if (input.value.trim()) {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "btn btn-xs btn-outline";
                button.textContent = input.value.trim();
                button.onclick = () => addToFormula(input.value.trim());
                variablesButtons.appendChild(button);
            }
        });
    }
}

function populateNumbersButtons() {
    const numbersButtons = document.getElementById("numbers-buttons");
    if (!numbersButtons) return;
    
    numbersButtons.innerHTML = "";
    
    // ตัวเลข 0-9
    for (let i = 0; i <= 9; i++) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn btn-xs btn-outline";
        button.textContent = i.toString();
        button.onclick = () => addToFormula(i.toString());
        numbersButtons.appendChild(button);
    }
    
    // จุดทศนิยม
    const decimalButton = document.createElement("button");
    decimalButton.type = "button";
    decimalButton.className = "btn btn-xs btn-outline";
    decimalButton.textContent = ".";
    decimalButton.onclick = () => addToFormula(".");
    numbersButtons.appendChild(decimalButton);
}

function populateOperatorsButtons() {
    const operatorsButtons = document.getElementById("operators-buttons");
    if (!operatorsButtons) return;
    
    operatorsButtons.innerHTML = "";
    
    const operators = ['+', '-', '*', '/', '(', ')', '^', 'sqrt', '⌫', 'C'];
    
    operators.forEach(op => {
        const button = document.createElement("button");
        button.type = "button";
        
        if (op === '⌫') {
            button.textContent = "⌫";
            button.className = "btn btn-xs btn-error";
            button.onclick = () => removeLastCharacter();
        } else if (op === 'C') {
            button.textContent = "Clear";
            button.className = "btn btn-xs btn-warning";
            button.onclick = () => clearFormula();
        } else if (op === 'sqrt') {
            button.textContent = "√";
            button.className = "btn btn-xs btn-outline";
            button.onclick = () => addToFormula("sqrt(");
        } else {
            button.textContent = op;
            button.className = "btn btn-xs btn-outline";
            button.onclick = () => addToFormula(op);
        }
        
        operatorsButtons.appendChild(button);
    });
}

function removeLastCharacter() {
    const formulaInput = document.getElementById("formula");
    if (formulaInput) {
        formulaInput.value = formulaInput.value.slice(0, -1);
        updatePreview();
    }
}

function submitEditForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'กำลังบันทึก...';
    submitButton.disabled = true;

    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'สำเร็จ!',
                text: data.message,
                confirmButtonText: 'ตกลง'
            }).then(() => {
                window.location.href = data.redirect_url;
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด!',
                text: data.message,
                confirmButtonText: 'ตกลง'
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด!',
            text: 'เกิดข้อผิดพลาดในการส่งข้อมูล',
            confirmButtonText: 'ตกลง'
        });
    })
    .finally(() => {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
}

function initializeForm() {
    inputFieldCount = 0;
    currentFormula = '';
    const container = document.getElementById("input-fields-container");
    if (container) container.innerHTML = "";
    
    // ใช้ข้อมูลจาก template แทนการ fetch
    const form = {{ form|tojson if form else 'null' }};
    if (form) {
        loadFormData(form);
    } else {
        addInputField();
        setTimeout(() => {
            updatePreview();
            updateCalculatorButtons();
            feather.replace();
        }, 100);
    }
}

async function loadFormData(formData) {
    const container = document.getElementById("input-fields-container");
    if (container) container.innerHTML = "";
    inputFieldCount = 0;
    
    // ถ้าเป็นฟอร์มลิงก์ ให้โหลดข้อมูล linked material
    if (formData.is_linked && formData.linked_material_name) {
        await loadLinkedMaterialData(formData.linked_material_name);
    }
    
    // เฉพาะฟอร์มปกติจึงจะโหลด input fields
    if (!formData.is_linked && formData.input_types && formData.input_types.length > 0) {
        formData.input_types.forEach(inputField => {
            addInputField({
                field: inputField.field,
                label: inputField.label,
                input_type: inputField.input_type,
                unit: inputField.unit
            });
        });
    } else if (!formData.is_linked) {
        // ถ้าเป็นฟอร์มปกติแต่ไม่มี input types
        addInputField();
    }
    
    setTimeout(() => {
        // กรอกข้อมูลที่มีอยู่แล้ว
        if (formData.material_name) {
            const materialInput = document.querySelector("input[name='material_name']");
            if (materialInput) materialInput.value = formData.material_name;
        }
        if (formData.desc_form) {
            const descFormTextarea = document.querySelector("textarea[name='desc_form']");
            if (descFormTextarea) descFormTextarea.value = formData.desc_form;
        }
        if (formData.formula) {
            const formulaInput = document.querySelector("input[name='formula']");
            if (formulaInput) formulaInput.value = formData.formula;
        }
        if (formData.desc_formula) {
            const descFormulaTextarea = document.querySelector("textarea[name='desc_formula']");
            if (descFormulaTextarea) descFormulaTextarea.value = formData.desc_formula;
        }
        if (formData.ghg_scope) {
            const mainScopeSelect = document.querySelector("select[name='scope']");
            if (mainScopeSelect) mainScopeSelect.value = formData.ghg_scope;
        }
        
        setTimeout(() => {
            updatePreview();
            updateCalculatorButtons();
            feather.replace();
        }, 200);
    }, 50);
}

function updatePreview() {
    const container = document.getElementById("input-fields-container");
    const preview = document.getElementById("form-preview");
    const materialName = (document.querySelector("input[name='material_name']").value || "NO MATERIAL NAME").toUpperCase();
    
    // Check if form is linked
    const isLinked = {{ 'true' if form and form.is_linked else 'false' }};
    
    let html = "";
    html += `<div class="mb-6"><p class="text-sm text-gray-400"><strong>{{ t.material_name|upper }}:</strong> ${materialName}</p></div>`;

    if (isLinked && linkedMaterialData) {
        // แสดงข้อมูลฟอร์มลิงก์
        html += `<div class="alert bg-blue-50 border border-blue-300 text-blue-800 mb-4">
            <div class="text-sm">
                <p><strong>เชื่อมโยงกับ Material:</strong> 
                   <span class="font-mono bg-gray-100 border border-gray-300 px-2 py-1 rounded text-gray-800">${linkedMaterialData.material_name}</span>
                </p>
                <p><strong>Scope:</strong> <span class="text-blue-700">${linkedMaterialData.ghg_scope}</span> | <strong>Sub-Scope:</strong> <span class="text-blue-700">${linkedMaterialData.ghg_sup_scope}</span></p>
                <p class="text-xs text-blue-700 mt-1">ข้อมูลจะถูกดึงจากฟอร์มต้นทางโดยอัตโนมัติ</p>
            </div>
        </div>`;
        
        // แสดงฟิลด์จาก linked material
        linkedMaterialData.input_types.forEach(inputType => {
            html += `<div class="mb-6">
                <label class="block text-sm text-gray-700 mb-1">
                    <strong>${inputType.label || inputType.field} (${inputType.unit || 'unit'})</strong>
                </label>
                <div class="relative">
                    <input type="${inputType.input_type}" 
                           class="input input-bordered w-full mb-2 bg-gray-50 border-gray-200" 
                           placeholder="กรอก ${inputType.label || inputType.field}">
                    <div class="flex gap-2 mt-2">
                        <div class="text-xs text-gray-600 bg-gray-100 border border-gray-200 rounded-full px-3 py-1 inline-block">Field: ${inputType.field}</div>
                        <div class="text-xs text-blue-600 bg-blue-100 border border-blue-200 rounded-full px-3 py-1 inline-block">Type: ${inputType.input_type}</div>
                    </div>
                </div>
            </div>`;
        });
    } else if (isLinked) {
        // ฟอร์มลิงก์แต่ยังไม่มีข้อมูล
        html += `<div class="alert bg-blue-50 border border-blue-300 text-blue-800 mb-4">
            <div class="text-sm">
                <p><strong>เชื่อมโยงกับ Material:</strong> 
                   <span class="font-mono bg-gray-100 border border-gray-300 px-2 py-1 rounded text-gray-800">{{ form.linked_material_name if form and form.linked_material_name else 'N/A' }}</span>
                </p>
                <p class="text-xs text-blue-700 mt-1">กำลังโหลดข้อมูล...</p>
            </div>
        </div>`;
    } else {
        // ฟอร์มปกติ
        const descForm = document.querySelector("textarea[name='desc_form']").value || "No Description";
        const mainScope = document.querySelector("select[name='scope']").value || "-";
        const subScope = document.querySelector("select[name='sup_scope']").value || "-";
        
        html += `<div class="mb-4">
            <p class="text-sm text-gray-600">{{ t.material_name }}: ${materialName}</p>
            <p class="text-sm text-gray-600">{{ t.form_description }}: ${descForm}</p>
            <div class="flex gap-4 mt-2">
                <div class="text-xs text-gray-700 bg-gray-100 rounded-full px-3 py-1 inline-block">Main Scope: ${mainScope}</div>
                <div class="text-xs text-gray-700 bg-gray-100 rounded-full px-3 py-1 inline-block">Sub Scope: ${subScope}</div>
                <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">ฟอร์มปกติ</div>
            </div>
        </div>`;

        // Show input fields for normal form
        if (container) {
            const fields = container.querySelectorAll("[data-index]");
            fields.forEach(row => {
                const field = row.querySelector("input[name='field']").value;
                const label = row.querySelector("input[name='label']").value;
                const inputType = row.querySelector("select[name='input_type']").value;
                const unit = row.querySelector("input[name='unit']").value;
                html += `<div class='mb-6'>
                    <label class='block text-sm text-gray-800 mb-1'><strong>${label || field} (${unit || '-'})</strong></label>
                    <div class="relative">
                        <input type='${inputType}' class='input input-bordered w-full mb-2' placeholder='{{t.enter}} ${label || field}'>
                        <div class="flex gap-2 mt-2">
                            <div class="text-xs text-gray-700 bg-gray-200 rounded-full px-3 py-1 inline-block">Field: ${field || "Unnamed Field"}</div>
                            <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">Type: ${inputType}</div>
                        </div>
                    </div>
                </div>`;
            });
        }
    }

    const formula = document.querySelector("input[name='formula']").value || "No Formula";
    const descFormula = document.querySelector("textarea[name='desc_formula']").value || "No Formula Description";
    html += `<div class="mt-6">
        <p class="text-sm text-gray-600">{{ t.formula }}: ${formula}</p>
        <p class="text-sm text-gray-600">{{ t.formula_description }}: ${descFormula}</p>
    </div>`;

    const currentUser = "{{ current_user.username if current_user else 'Unknown User' }}";
    const currentTime = new Date().toLocaleString();
    html += `<div class="mt-6 text-xs text-gray-500">
        <div class="flex items-center gap-2"><i data-feather="user" class="w-4 h-4"></i><span>แก้ไขโดย: ${currentUser}</span></div>
        <div class="flex items-center gap-2 mt-2"><i data-feather="clock" class="w-4 h-4"></i><span>แก้ไขเมื่อ: ${currentTime}</span></div>
    </div>`;

    preview.innerHTML = html || `<p class="italic text-sm text-gray-500">No fields added.</p>`;
    feather.replace();
}

function confirmDelete(formId, materialName) {
    if (confirm(`Are you sure you want to delete "${materialName}"?\n\nThis action cannot be undone.`)) {
        fetch(`{{ url_for('form_management.delete_form', form_id='') }}${formId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modal').classList.remove('modal-open');
                setTimeout(() => {
                    location.reload();
                }, 300);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred while deleting the form');
        });
    }
}

// Event listeners สำหรับ HTMX
document.addEventListener('htmx:afterSettle', function(event) {
    if (event.detail.target.querySelector('input[name="form_id"]')) {
        console.log("Edit form modal loaded, initializing...");
        feather.replace();
        setTimeout(() => {
            initializeForm();
        }, 100);
    }
    
    // ถ้าเป็นการโหลด sub-scope container
    if (event.detail.target.id === 'sub-scope-container' || 
        event.detail.target.closest('#sub-scope-container') ||
        event.detail.target.querySelector('select[name="sup_scope"]')) {
        console.log("Sub scope container loaded/updated");
        setTimeout(() => {
            updatePreview();
            feather.replace();
        }, 50);
    }
});

// Initialize when DOM loads
document.addEventListener("DOMContentLoaded", function() {
    if (document.querySelector('input[name="form_id"]')) {
        console.log("Edit form DOM ready, initializing...");
        feather.replace();
        initializeForm();
        
        // เรียกใช้ updateCalculatorButtons เพิ่มเติมเพื่อให้แน่ใจว่าเครื่องคิดเลขพร้อมใช้งาน
        setTimeout(() => {
            updateCalculatorButtons();
            console.log("Calculator buttons initialized");
        }, 1000);
    }
});
</script>