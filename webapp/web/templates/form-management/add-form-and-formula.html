<div class="max-w-6xl mx-auto px-6 py-8">
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Left: Create Form Field -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <h3 class="text-black-600 font-bold text-lg mb-4 border-b border-b-gray-200 pb-3">{{ t.create_form_field }}</h3>
      <form id="add-form" method="POST" action="{{ url_for('form_management.add_form_and_formula') }}" onsubmit="submitForm(event)">

        <!-- Form Metadata -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-font">{{ t.form_name }}</label>
            <input 
              type="text" 
              name="name" 
              class="input input-bordered w-full mt-1" 
              placeholder="{{ t.enter_form_name }}" 
              value="{{ form_data.name if form_data else '' }}"
              oninput="updatePreview()"
              required>
          </div>

          <div>
            <label class="text-font">{{ t.material_name }}</label>
            <input 
              type="text" 
              name="material_name" 
              class="input input-bordered w-full mt-1" 
              placeholder="{{ t.enter_material_name }}" 
              value="{{ form_data.material_name if form_data else '' }}"
              oninput="updatePreview()"
              required>
          </div>

          <!-- แก้ไขส่วน Main Scope -->
          <div>
            <label class="text-font">{{ t.main_scope }}</label>
            <select 
              name="scope" 
              id="main-scope"
              class="select select-bordered w-full mt-1" 
              hx-get="/form-management/get-sub-scopes/"
              hx-target="#sub-scope-container"
              hx-trigger="change"
              hx-include="[name='scope']"
              {% if default_sub_scope %}
              hx-vals='{"selected": "{{ default_sub_scope }}"}'
              {% endif %}
              onchange="updatePreview()"
              required>
              <option value="">เลือก Main Scope</option>
              <option value="1" {{ 'selected' if default_scope == '1' else '' }}>Scope 1</option>
              <option value="2" {{ 'selected' if default_scope == '2' else '' }}>Scope 2</option>
              <option value="3" {{ 'selected' if default_scope == '3' else '' }}>Scope 3</option>
            </select>
          </div>

          <!-- แก้ไขส่วน Sub Scope -->
          <div>
            <label class="text-font">{{ t.sub_scope }}</label>
            <div id="sub-scope-container">
              {% if default_scope %}
                <!-- ถ้ามี default scope ให้โหลด sub-scopes ทันที พร้อมส่ง selected -->
                <div hx-get="/form-management/get-sub-scopes/{{ default_scope }}{% if default_sub_scope %}?selected={{ default_sub_scope }}{% endif %}"
                     hx-trigger="load"
                     hx-target="this"
                     hx-swap="outerHTML">
                  <select name="sup_scope" class="select select-bordered w-full mt-1" required>
                    <option value="">กำลังโหลด Sub Scopes...</option>
                  </select>
                </div>
              {% else %}
                <select 
                  name="sup_scope" 
                  id="sub-scope"
                  class="select select-bordered w-full mt-1"
                  onchange="updatePreview()"
                  required>
                  <option value="">เลือก Main Scope ก่อน</option>
                </select>
              {% endif %}
            </div>
          </div>

          <div class="sm:col-span-2">
            <label class="text-font">{{ t.form_description }}</label>
            <textarea 
              name="desc_form" 
              class="textarea textarea-bordered w-full mt-1" 
              placeholder="{{ t.enter_form_description }}"
              oninput="updatePreview()"
            >{{ form_data.desc_form if form_data else '' }}</textarea>
          </div>
        </div>

        <!-- Define Input Fields -->
        <div class="mt-6">
          <label class="text-font">{{ t.define_input_fields }}</label>
          <div id="input-fields-container" class="space-y-4">
            <!-- ฟิลด์ที่เพิ่มจะถูกแทรกที่นี่ -->
          </div>
          <!-- ปุ่ม Add Input Field -->
          <button 
            type="button" 
            class="btn btn-outline btn-lg mt-2 w-full border-dashed flex items-center justify-center gap-3 py-4 bg-gray-50 hover:bg-gray-100 text-gray-600 text-sm" 
            onclick="addInputField()">
            <i data-feather="plus" class="w-6 h-6"></i>
            {{ t.add_input_field }}
          </button>
        </div>

        <!-- Formula Section -->
        <div class="mt-6">
          <label class="text-font">{{ t.formula }}</label>
          <div class="relative mb-4">
            <div class="flex">
              <input 
                type="text" 
                name="formula" 
                id="formula" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. diesel * 2.68" 
                readonly 
                required
                onclick="toggleFormulaCalculator()">
              
              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormulaCalculator()"
                      title="{{ t.open_formula_calculator }}">
                <i data-feather="grid" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>
            
            <!-- Formula Calculator Dropdown -->
            <div id="formula-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{ t.formula_builder }}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormulaCalculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>

              <!-- Variables Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.variables }}</h5>
                <div class="grid grid-cols-4 gap-2" id="variables-buttons">
                  <!-- ปุ่มตัวแปรจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.numbers }}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers-buttons">
                  <!-- ปุ่มตัวเลขจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.operators }}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators-buttons">
                  <!-- ปุ่มสัญลักษณ์ทางคณิตศาสตร์จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormulaCalculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Formula 2 Section -->
        <div class="mt-6">
          <label class="text-font">{{ t.formula_2 }} ({{ t.advanced_calculation }})</label>
          <div class="relative mb-4">
            <div class="flex">
              <input 
                type="text" 
                name="formula2" 
                id="formula2" 
                class="input input-bordered w-full cursor-not-allowed" 
                placeholder="e.g. result * 2.5 + result * carbon_factor" 
                readonly
                onclick="toggleFormula2Calculator()">

              <!-- Dropdown Button -->
              <button type="button" 
                      id="formula2-dropdown-btn"
                      class="btn btn-outline ml-2 px-3"
                      onclick="toggleFormula2Calculator()"
                      title="Open Formula 2 Calculator">
                <i data-feather="trending-up" class="w-4 h-4 mr-1"></i>
                <i data-feather="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>

            <!-- Formula 2 Calculator Dropdown -->
            <div id="formula2-calculator" class="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden mt-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold text-gray-700">{{ t.formula_2_builder }}</h4>
                <button type="button" class="btn btn-sm btn-ghost" onclick="closeFormula2Calculator()">
                  <i data-feather="x" class="w-4 h-4"></i>
                </button>
              </div>
              <p class="text-sm text-gray-500 mb-3">{{ t.use_result_from_formula_1 }}</p>

              <!-- Result Variable Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.result_variable }}</h5>
                <div class="grid grid-cols-1 gap-2" id="result-buttons">
                  <button type="button" class="btn btn-sm btn-outline bg-green-100 text-green-800" onclick="addToFormula2('result')">result</button>
                </div>
              </div>

              <!-- Constants Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.constants }}</h5>
                <div class="grid grid-cols-3 gap-2" id="constants-buttons">
                  <!-- ปุ่มค่าคงที่จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Numbers Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.numbers }}</h5>
                <div class="grid grid-cols-5 gap-2" id="numbers2-buttons">
                  <!-- ปุ่มตัวเลขจะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Operators Section -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-600 mb-2">{{ t.operators }}</h5>
                <div class="grid grid-cols-5 gap-2" id="operators2-buttons">
                  <!-- ปุ่มสัญลักษณ์ทางคณิตศาสตร์จะถูกเพิ่มที่นี่ -->
                </div>
              </div>

              <!-- Actions -->
              <div class="flex justify-between">
                <button type="button" class="btn btn-sm btn-outline" onclick="closeFormula2Calculator()">{{ t.cancel }}</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyFormula2()">{{ t.apply }}</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_description }}</label>
          <textarea 
            name="desc_formula" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_description }}" 
            oninput="updatePreview()"
          ></textarea>
        </div>

        <div class="sm:col-span-2 mt-4">
          <label class="text-font">{{ t.formula_2_description }}</label>
          <textarea 
            name="desc_formula2" 
            class="textarea textarea-bordered w-full mt-1" 
            placeholder="{{ t.enter_formula_2_description }}" 
            oninput="updatePreview()"
          ></textarea>
        </div>

        <!-- เพิ่มส่วนนี้ที่ด้านบนของฟอร์ม -->
        {% if error_msg %}
        <div class="alert alert-error mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ error_msg }}</span>
        </div>
        {% endif %}

        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="btn btn-outline" onclick="document.getElementById('modal').classList.remove('modal-open')">{{ t.cancel }}</button>
          <button type="submit" class="btn btn-primary">{{ t.add_form }}</button>
        </div>
      </form>
    </div>

    <!-- Right: Form Preview -->
    <div class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
      <h3 class="text-black-600 font-bold text-lg mb-4">{{ t.form_preview }}</h3>
      <div id="form-preview" class="bg-white rounded-[7px] border border-gray-300 shadow-md p-6">
        <p class="italic text-sm text-gray-500">{{ t.input_fields_preview }}</p>
      </div>
    </div>
  </div>
</div>

<!-- เพิ่ม SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- เพิ่ม shared JavaScript -->
<script src="{{ url_for('static', filename='js/form-calculator.js') }}"></script>

<script>
function initializeForm() {
    console.log("Initializing add form...");
    
    if (isFormInitialized) {
        console.log("Form already initialized, skipping...");
        return;
    }
    
    inputFieldCount = 0;
    currentFormula = '';
    currentFormula2 = '';
    
    const container = document.getElementById("input-fields-container");
    if (!container) {
        console.error("Container not found, retrying...");
        setTimeout(initializeForm, 100);
        return;
    }
    
    container.innerHTML = "";
    addInputField();
    isFormInitialized = true;
    
    setTimeout(() => {
        updatePreview();
        updateFormulaButtons();
        updateFormula2Buttons();
        feather.replace();
    }, 100);
}

function updatePreview() {
    const container = document.getElementById("input-fields-container");
    const preview = document.getElementById("form-preview");
    
    if (!container || !preview) {
        return;
    }
    
    const fields = container.querySelectorAll("[data-index]");
    let html = "";

    const materialName = (document.querySelector("input[name='material_name']")?.value || "{{ t.no_material_name }}").toUpperCase();

    html += `
    <div class="mb-6">
        <p class="text-sm text-gray-400"><strong>{{ t.material_name|upper }}:</strong> ${materialName}</p>
    </div>`;

    const formName = document.querySelector("input[name='name']")?.value || "{{ t.untitled_form }}";
    const descForm = document.querySelector("textarea[name='desc_form']")?.value || "{{ t.no_description }}";
    
    const mainScope = document.querySelector("select[name='scope']")?.value || "-";
    const subScope = document.querySelector("select[name='sup_scope']")?.value || "-";

    html += `
    <div class="mb-4">
        <p class="text-sm text-gray-600">{{ t.form_name }}: ${formName}</p>
        <p class="text-sm text-gray-600">{{ t.form_description }}: ${descForm}</p>
        <div class="flex gap-4 mt-2">
            <div class="text-xs text-gray-700 bg-purple-100 rounded-full px-3 py-1 inline-block">
                Main Scope: ${mainScope}
            </div>
            <div class="text-xs text-gray-700 bg-indigo-100 rounded-full px-3 py-1 inline-block">
                Sub Scope: ${subScope}
            </div>
        </div>
    </div>`;

    fields.forEach(row => {
        const field = row.querySelector("input[name='field']")?.value;
        const label = row.querySelector("input[name='label']")?.value;
        const inputType = row.querySelector("select[name='input_type']")?.value;
        const unit = row.querySelector("input[name='unit']")?.value;

        html += `<div class='mb-6'>
            <label class='block text-sm text-gray-800 mb-1'><strong>${label || field} (${unit || '-'})</strong></label>
            <div class="relative">
                <input type='${inputType}' class='input input-bordered w-full mb-2' placeholder='{{ t.enter }} ${label || field}'>
                <div class="flex gap-2 mt-2">
                    <div class="text-xs text-gray-700 bg-gray-200 rounded-full px-3 py-1 inline-block">
                        Field: ${field || "Unnamed Field"}
                    </div>
                    <div class="text-xs text-gray-700 bg-blue-100 rounded-full px-3 py-1 inline-block">
                        Type: ${inputType}
                    </div>
                </div>
            </div>
        </div>`;
    });

    const formula = document.querySelector("input[name='formula']")?.value || "{{ t.no_formula }}";
    const descFormula = document.querySelector("textarea[name='desc_formula']")?.value || "{{ t.no_formula_description }}";
    const formula2 = document.querySelector("input[name='formula2']")?.value || "";
    const descFormula2 = document.querySelector("textarea[name='desc_formula2']")?.value || "";

    html += `
    <div class="mt-6">
        <p class="text-sm text-gray-600">{{ t.formula }}: ${formula}</p>
        <p class="text-sm text-gray-600">{{ t.formula_description }}: ${descFormula}</p>
    </div>`;

    if (formula2) {
        html += `
        <div class="mt-4">
            <p class="text-sm text-gray-600">{{ t.formula_2 }}: ${formula2}</p>
            <p class="text-sm text-gray-600">{{ t.formula_2_description }}: ${descFormula2}</p>
        </div>`;
    }

    const currentUser = "{{ current_user.username if current_user else 'Unknown User' }}";
    const currentTime = new Date().toLocaleString();

    html += `
    <div class="mt-6 text-xs text-gray-500">
        <div class="flex items-center gap-2">
            <i data-feather="user" class="w-4 h-4"></i>
            <span>สร้างโดย: ${currentUser}</span>
        </div>
        <div class="flex items-center gap-2 mt-2">
            <i data-feather="clock" class="w-4 h-4"></i>
            <span>สร้างเมื่อ: ${currentTime}</span>
        </div>
    </div>`;

    preview.innerHTML = html || `<p class="italic text-sm text-gray-500">No fields added.</p>`;
    feather.replace();
}

function submitForm(event) {
    event.preventDefault();
    
    if (typeof Swal === 'undefined') {
        alert('SweetAlert2 ยังไม่โหลด กรุณาลองใหม่อีกครั้ง');
        return false;
    }
    
    const form = event.target;
    const formData = new FormData(form);
    
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'กำลังบันทึก...';
    submitButton.disabled = true;
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'สำเร็จ!',
                text: data.message,
                confirmButtonText: 'ตกลง'
            }).then(() => {
                window.location.href = data.redirect_url;
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด!',
                text: data.message,
                confirmButtonText: 'ตกลง'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด!',
            text: 'เกิดข้อผิดพลาดในการส่งข้อมูล',
            confirmButtonText: 'ตกลง'
        });
    })
    .finally(() => {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
    
    return false;
}

// Initialize when DOM loads or when modal content loads
document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM loaded (initial)");
    
    if (document.getElementById('add-form')) {
        initializeForm();
        setTimeout(triggerSubScopeLoad, 200);
    }
});
</script>